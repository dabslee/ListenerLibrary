{% load static %}
{% load player_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ListenerLibrary</title>
    <link rel="icon" href="{% static 'images/logo.png' %}" type="image/svg+xml">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link href="{% static 'css/themes.css' %}" rel="stylesheet">
</head>
<body {% block bodymods %}{% endblock %}>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'track_list' %}">
                <img src="{% static 'images/logo.png' %}" alt="ListenerLibrary Logo" width="30" height="30" class="d-inline-block align-top">
                ListenerLibrary
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-text d-none" id="sleep-timer-display">
                    <div class="badge bg-secondary"><i class="fas fa-moon me-2"></i> <span id="sleep-timer-nav-countdown"></span></div>
                </div>
                <ul class="navbar-nav ms-auto">
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'play_focus' %}">Player</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'track_list' %}">Tracks</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'playlist_list' %}">Playlists</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                {{ user.username }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                                <li class="px-2">
                                    <div class="form-group">
                                        <small class="text-secondary ps-1">Theme</small>
                                        <select class="form-control" id="theme-select">
                                            <option value="light">Light</option>
                                            <option value="dark">Dark</option>
                                            <option value="light-blue">Light blue</option>
                                            <option value="dark-blue">Dark blue</option>
                                        </select>
                                    </div>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item d-flex justify-content-between align-items-center" href="#" data-bs-toggle="modal" data-bs-target="#sleep-timer-modal">
                                        Sleep Timer
                                        <span id="sleep-timer-mobile-countdown" class="badge rounded-pill bg-secondary d-none"></span>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bookmarks-modal">
                                        Bookmarks
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'password_reset' %}">Reset password</a></li>
                                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">Logout</a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'login' %}">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'register' %}">Register</a>
                        </li>
                    {% endif %}
                </ul>
                <form id="logout-form" action="{% url 'logout' %}" method="post" style="display: none;">
                    {% csrf_token %}
                </form>
            </div>
        </div>
    </nav>

    <div class="modal fade" id="sleep-timer-modal" tabindex="-1" aria-labelledby="sleep-timer-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sleep-timer-modal-label">Sleep Timer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="setup-timer-view">
                        <p>Set a timer to stop playback after a certain amount of time.</p>
                        <div class="input-group">
                            <input type="number" id="sleep-timer-minutes" class="form-control" placeholder="Minutes" min="1">
                            <button class="btn btn-primary" id="start-sleep-timer">Start</button>
                        </div>
                    </div>
                    <div id="active-timer-view" style="display: none;">
                        <p>Time remaining: <span id="sleep-timer-countdown"></span></p>
                        <button class="btn btn-secondary" id="pause-resume-sleep-timer">Pause</button>
                        <button class="btn btn-danger" id="cancel-sleep-timer">Cancel Timer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bookmarks-modal" tabindex="-1" aria-labelledby="bookmarks-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookmarks-modal-label">Bookmarks</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="create-bookmark-form">
                        {% csrf_token %}
                        <div class="input-group mb-3">
                            <div class="d-flex flex-column">
                                <div class="col-auto"><label for="name" class="col-form-label">Add new bookmark at current position:</label></div>
                                <div class="d-flex flex-row align-items-center gap-2">
                                    {{ bookmark_form.name }}
                                    <button class="btn btn-primary" type="submit">Save</button>
                                </div>
                            </div>
                        </div>
                    </form>

                    <div id="bookmark-list" class="list-group" style="max-height: 300px; overflow-y: auto; mt-1">
                        <p>Saved bookmarks:</p>
                        {% for bookmark in bookmarks %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ bookmark.name }}</h6>
                                    <small class="text-muted">"{{ bookmark.track.name }}" at {{ bookmark.position|format_duration }}</small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary play-bookmark-btn" data-bookmark-id="{{ bookmark.id }}"><i class="fas fa-play"></i></button>
                                    <button class="btn btn-sm btn-outline-danger delete-bookmark-btn" data-bookmark-id="{{ bookmark.id }}"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-muted">No bookmarks saved yet.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <main class="container mt-4 mb-5 pb-5">
        <div class="toast-container position-fixed start-0 p-3" style="z-index: 1100; top: 3rem;">
            <!-- Toasts will be appended here -->
        </div>
        {% block content %}{% endblock %}
    </main>

    {% block player_footer %}{% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    {{ podcast_positions_json|json_script:"podcast-positions-data" }}

    <script id="playback-state-data" type="application/json">
    {% if playback_state and playback_state.track %}
    {
        "trackId": {{ playback_state.track.id }},
        "trackName": "{{ playback_state.track.name|escapejs }}",
        "trackArtist": "{% if playback_state.track.artist %}{{ playback_state.track.artist|escapejs }}{% else %}No artist{% endif %}",
        "trackIcon": "{% if playback_state.track.icon %}{{ playback_state.track.icon.url }}{% else %}{% endif %}",
        "trackStreamUrl": "{% url 'stream_track' playback_state.track.id %}",
        "position": {{ playback_state.last_played_position }},
        "trackType": "{{ playback_state.track.type }}",
        "playlist": {% if playback_state.playlist %}{
            "id": {{ playback_state.playlist.id }},
            "name": "{{ playback_state.playlist.name|escapejs }}"
        }{% else %}null{% endif %},
        "shuffle": {% if playback_state.shuffle %}true{% else %}false{% endif %}
    }
    {% endif %}
    </script>

    <script src="{% static 'js/player.js' %}"></script>
    <script src="{% static 'js/toasts.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('bookmark-list').addEventListener('click', function(event) {
                const playButton = event.target.closest('.play-bookmark-btn');
                const deleteButton = event.target.closest('.delete-bookmark-btn');

                if (playButton) {
                    const bookmarkId = playButton.dataset.bookmarkId;
                    const url = `/bookmark/${bookmarkId}/play/`;
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showToast(data.message, 'success');
                            if (window.loadPlaybackState && data.playback_state) {
                                window.loadPlaybackState(data.playback_state);
                            } else {
                                location.reload();
                            }
                            const bookmarksModal = document.getElementById('bookmarks-modal');
                            const modalInstance = bootstrap.Modal.getInstance(bookmarksModal);
                            if (modalInstance) {
                                modalInstance.hide();
                            }
                        } else {
                            showToast(data.message || 'An error occurred.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('An error occurred.', 'error');
                    });
                } else if (deleteButton) {
                    const bookmarkId = deleteButton.dataset.bookmarkId;
                    const url = `/bookmark/${bookmarkId}/delete/`;
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    if (confirm('Are you sure you want to delete this bookmark?')) {
                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                showToast(data.message, 'success');
                                deleteButton.closest('.list-group-item').remove();
                            } else {
                                showToast(data.message || 'An error occurred.', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showToast('An error occurred.', 'error');
                        });
                    }
                }
            });

            const themeSelect = document.getElementById('theme-select');
            const htmlElement = document.documentElement;
            const savedTheme = localStorage.getItem('theme') || 'light';

            function applyTheme(theme) {
                htmlElement.setAttribute('data-theme', theme);
                if (themeSelect) {
                    themeSelect.value = theme;
                }
                localStorage.setItem('theme', theme);
            }

            // Apply the saved theme on initial load
            applyTheme(savedTheme);

            // Add event listener to the theme selector
            if (themeSelect) {
                themeSelect.addEventListener('change', function() {
                    applyTheme(this.value);
                });
            }

            const createBookmarkForm = document.getElementById('create-bookmark-form');
            if (createBookmarkForm) {
                createBookmarkForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    const formData = new FormData(this);
                    const url = "{% url 'create_bookmark' %}";
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    fetch(url, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrfToken,
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showToast(data.message, 'success');
                            const bookmarkList = document.getElementById('bookmark-list');
                            const noBookmarksMessage = bookmarkList.querySelector('p.text-muted');
                            if (noBookmarksMessage) {
                                noBookmarksMessage.remove();
                            }
                            bookmarkList.insertAdjacentHTML('beforeend', data.bookmark_item_html);
                            createBookmarkForm.reset();
                        } else {
                            showToast(data.message || 'An error occurred.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('An error occurred.', 'error');
                    });
                });
            }
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>