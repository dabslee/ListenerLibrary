{% extends "base.html" %}

{% block content %}
    <div class="container mt-4">
        <div class="card">
            <div class="card-header">
                <h2>Upload New Playlist</h2>
            </div>
            <div class="card-body">
                <form id="upload-form" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_name" class="form-label">Playlist Name</label>
                        {{ form.name }}
                    </div>
                    <div class="mb-3">
                        <label for="id_image" class="form-label">Playlist Image</label>
                        {{ form.image }}
                    </div>
                    <div class="mb-3">
                        <label for="id_tracks" class="form-label">Track Files</label>
                        <input type="file" name="tracks" multiple class="form-control" required id="id_tracks">
                    </div>
                    <div class="mb-3">
                        <label for="id_default_track_icon" class="form-label">Default Track Icon (Optional)</label>
                        {{ form.default_track_icon }}
                    </div>

                    <!-- Error container for AJAX responses -->
                    <div id="error-container" class="alert alert-danger d-none" role="alert"></div>

                    <!-- Progress bar -->
                    <div id="progress-container" class="progress mt-3 d-none">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>

                    <button type="submit" id="upload-button" class="btn btn-primary mt-3">Upload Playlist</button>
                    <a href="{% url 'playlist_list' %}" class="btn btn-secondary mt-3">Cancel</a>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('upload-form');
    const uploadButton = document.getElementById('upload-button');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const errorContainer = document.getElementById('error-container');

    form.addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(form);
        const xhr = new XMLHttpRequest();

        xhr.open('POST', form.action, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.upload.addEventListener('progress', function (e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                const percentStr = percentComplete.toFixed(0) + '%';
                progressBar.style.width = percentStr;
                progressBar.textContent = percentStr;
                progressBar.setAttribute('aria-valuenow', percentComplete);
            }
        });

        xhr.addEventListener('loadstart', function() {
            progressContainer.classList.remove('d-none');
            uploadButton.disabled = true;
            uploadButton.textContent = 'Uploading...';
            errorContainer.classList.add('d-none');
        });

        xhr.addEventListener('load', function () {
            if (xhr.status >= 200 && xhr.status < 300) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.status === 'success') {
                        progressBar.classList.add('bg-success');
                        progressBar.textContent = 'Upload Complete!';
                        window.location.href = response.redirect_url;
                    } else {
                        handleErrorResponse(response.errors);
                    }
                } catch (err) {
                     handleErrorResponse({ __all__: ['An unexpected error occurred. Please try again.'] });
                }
            } else {
                 handleErrorResponse({ __all__: [`Server returned status ${xhr.status}. Please try again.`] });
            }
        });

        xhr.addEventListener('error', function () {
            handleErrorResponse({ __all__: ['An error occurred during the upload. Please check your network connection and try again.'] });
        });

        xhr.addEventListener('loadend', function() {
            const response = xhr.responseText ? JSON.parse(xhr.responseText) : {};
            if (response.status !== 'success') {
                uploadButton.disabled = false;
                uploadButton.textContent = 'Upload Playlist';
                progressContainer.classList.add('d-none');
            }
        });

        xhr.send(formData);
    });

    function handleErrorResponse(errors) {
        let errorHtml = '';
        if (typeof errors === 'object' && errors !== null) {
            for (const field in errors) {
                if (errors.hasOwnProperty(field)) {
                    const prefix = field === '__all__' ? '' : `${field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}: `;
                    errorHtml += `<p>${prefix}${errors[field][0].message || errors[field][0]}</p>`;
                }
            }
        } else {
            errorHtml = '<p>An unexpected error occurred.</p>';
        }

        errorContainer.innerHTML = errorHtml;
        errorContainer.classList.remove('d-none');
    }
});
</script>
{% endblock %}