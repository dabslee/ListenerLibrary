{% extends "base.html" %}
{% load static %}
{% load player_extras %}
{% load player_extras %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Your Tracks</h2>
        <div class="d-flex flex-column flex-md-row align-items-md-center gap-3">
            {% with percentage=storage_percentage|default:0 %}
            <span class="small fst-italic {% if storage_percentage > 75 %}text-danger{% else %}text-muted{% endif %}">{{ storage_usage|format_bytes }} / {{ storage_limit|format_bytes }} ({{ percentage|floatformat:1 }}%) used.</span>
            {% endwith %}
            <a href="{% url 'upload_track' %}" class="btn btn-primary"><i class="fas fa-upload me-1"></i> Upload Track</a>
        </div>
    </div>

    <!-- <div class="card bg-light mb-4">
        <div class="card-body">
            <h5>Storage Status</h5>
            {% with percentage=storage_percentage|default:0 %}
            <div class="progress mb-2" style="height: 20px;">
                <div class="progress-bar {% if percentage > 95 %}bg-danger{% elif percentage > 80 %}bg-warning{% endif %}" role="progressbar" style="width: {{ percentage }}%;" aria-valuenow="{{ percentage }}" aria-valuemin="0" aria-valuemax="100">
                    {{ percentage|floatformat:1 }}%
                </div>
            </div>
            <p class="text-muted mb-0">
                You've used {{ storage_usage|format_bytes }} of {{ storage_limit|format_bytes }}
            </p>
            {% endwith %}
        </div>
    </div> -->

    <div class="card bg-light mb-4">
        <div class="card-body">
            <form id="filter-sort-form" onsubmit="return false;">
                <div class="row g-3 align-items-end">
                    <!-- Search -->
                    <div class="col-md-4">
                        <label for="search-input" class="form-label">Search</label>
                        <input type="text" id="search-input" class="form-control" value="{{ search_query|default:'' }}" placeholder="Keyword...">
                    </div>
                    <!-- Filter by Artist -->
                    <div class="col-md-3">
                        <label for="artist-filter" class="form-label">Artist</label>
                        <select id="artist-filter" class="form-select">
                            <option value="">All Artists</option>
                            {% for artist in artists %}
                                {% if artist %}
                                    <option value="{{ artist }}" {% if artist == selected_artist %}selected{% endif %}>{{ artist }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Filter by Playlist -->
                    <div class="col-md-3">
                        <label for="playlist-filter" class="form-label">Playlist</label>
                        <select id="playlist-filter" class="form-select">
                            <option value="">All Tracks</option>
                            {% for p in playlists %}
                                <option value="{{ p.id }}" {% if p.id == selected_playlist_id %}selected{% endif %}>{{ p.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Sort by -->
                    <div class="col-md-2">
                        <label for="sort-select" class="form-label">Sort By</label>
                        <select id="sort-select" class="form-select">
                            <option value="name" {% if sort_option == 'name' %}selected{% endif %}>Alphabetical</option>
                            <option value="last_played" {% if sort_option == 'last_played' %}selected{% endif %}>Last Played</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="list-group" id="track-list-container">
        {% include 'player/partials/track_list_items.html' with tracks=tracks.object_list playlists=playlists %}
    </div>

    {% if tracks.has_next %}
        <div class="d-flex justify-content-center mt-4">
            <button id="load-more-btn" class="btn btn-outline-primary">Load More</button>
        </div>
    {% endif %}

    <div id="no-more-tracks" class="text-center text-muted mt-4" style="display: none;">
        No more tracks to load.
    </div>

{% endblock %}

{% block extra_js %}
<!-- Delete Track Modal -->
<div class="modal fade" id="deleteTrackModal" tabindex="-1" aria-labelledby="deleteTrackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTrackModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the track "<strong id="track-name-to-delete"></strong>"? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const artistFilter = document.getElementById('artist-filter');
    const playlistFilter = document.getElementById('playlist-filter');
    const sortSelect = document.getElementById('sort-select');
    const trackListContainer = document.getElementById('track-list-container');
    const allTracks = Array.from(trackListContainer.querySelectorAll('.track-item'));
    const noResultsMessage = document.querySelector('.alert-info');

    function filterAndSortTracks() {
        const searchQuery = searchInput.value.toLowerCase().trim();
        const selectedArtist = artistFilter.value.toLowerCase();
        const selectedPlaylistId = playlistFilter.value;
        const sortOption = sortSelect.value;

        let visibleTracks = [];

        allTracks.forEach(track => {
            const trackName = track.dataset.name;
            const trackArtist = track.dataset.artist;
            const trackPlaylists = track.dataset.playlists.split(',').filter(Boolean);

            const searchMatch = !searchQuery || trackName.includes(searchQuery) || trackArtist.includes(searchQuery);
            const artistMatch = !selectedArtist || trackArtist === selectedArtist;
            const playlistMatch = !selectedPlaylistId || trackPlaylists.includes(selectedPlaylistId);

            if (searchMatch && artistMatch && playlistMatch) {
                track.classList.remove('d-none');
                visibleTracks.push(track);
            } else {
                track.classList.add('d-none');
            }
        });

        // Sort the visible tracks
        visibleTracks.sort((a, b) => {
            if (sortOption === 'name') {
                return a.dataset.name.localeCompare(b.dataset.name);
            } else if (sortOption === 'last_played') {
                const dateA = a.dataset.lastPlayed ? new Date(a.dataset.lastPlayed) : null;
                const dateB = b.dataset.lastPlayed ? new Date(b.dataset.lastPlayed) : null;

                if (!dateA && !dateB) return 0;
                if (!dateA) return 1; // Unplayed tracks go to the end
                if (!dateB) return -1; // Played tracks come first
                return dateB - dateA; // Sort descending
            }
            return 0;
        });

        // Re-append sorted tracks to the container
        visibleTracks.forEach(track => trackListContainer.appendChild(track));

        // Show/hide the "no results" message
        if (noResultsMessage) {
            noResultsMessage.style.display = visibleTracks.length > 0 ? 'none' : 'block';
        }
    }

    // Attach event listeners
    searchInput.addEventListener('input', filterAndSortTracks);
    artistFilter.addEventListener('change', filterAndSortTracks);
    playlistFilter.addEventListener('change', filterAndSortTracks);
    sortSelect.addEventListener('change', filterAndSortTracks);

    // Initial filter on page load to respect any pre-filled values from URL params
    filterAndSortTracks();

    const deleteTrackModal = document.getElementById('deleteTrackModal');
    const trackNameToDelete = document.getElementById('track-name-to-delete');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    let trackIdToDelete = null;

    deleteTrackModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        trackIdToDelete = button.dataset.trackId;
        const trackName = button.dataset.trackName;
        trackNameToDelete.textContent = trackName;
    });

    confirmDeleteBtn.addEventListener('click', function () {
        if (!trackIdToDelete) return;

        const url = `/api/track/${trackIdToDelete}/delete/`;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '{{ csrf_token }}';

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast(data.message, 'success');
                const trackItem = document.querySelector(`[data-testid="track-item-${trackIdToDelete}"]`);
                if (trackItem) {
                    trackItem.remove();
                }
                const modalInstance = bootstrap.Modal.getInstance(deleteTrackModal);
                modalInstance.hide();
            } else {
                showToast(data.message || 'An error occurred.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred.', 'error');
        });
    });

    let page = 1;
    const loadMoreBtn = document.getElementById('load-more-btn');
    const trackListContainer = document.getElementById('track-list-container');
    const noMoreTracks = document.getElementById('no-more-tracks');

    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function () {
            page++;
            const url = `?page=${page}`;
            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.html) {
                    trackListContainer.insertAdjacentHTML('beforeend', data.html);
                }
                if (!data.has_next) {
                    loadMoreBtn.style.display = 'none';
                    noMoreTracks.style.display = 'block';
                }
            })
            .catch(error => console.error('Error loading more tracks:', error));
        });
    }
});

function addToPlaylist(trackId, playlistId, element) {
    const url = "{% url 'add_track_to_playlist' %}";
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '{{ csrf_token }}';


    const formData = new FormData();
    formData.append('track_id', trackId);
    formData.append('playlist_id', playlistId);

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        showToast(data.message, data.status);
        if (data.status === 'success') {
            // Add checkmark if it doesn't exist
            if (!element.querySelector('.fa-check')) {
                const checkmark = document.createElement('i');
                checkmark.className = 'fas fa-check text-success ms-2';
                element.appendChild(checkmark);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred while adding the track.', 'error');
    });
}
</script>
{% endblock %}