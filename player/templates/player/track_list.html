{% extends "base.html" %}
{% load static %}
{% load player_extras %}
{% load player_extras %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Your Tracks</h2>
        <div class="d-flex flex-column flex-md-row align-items-md-center gap-3">
            {% with percentage=storage_percentage|default:0 %}
            <span class="small fst-italic {% if storage_percentage > 75 %}text-danger{% else %}text-muted{% endif %}">{{ storage_usage|format_bytes }} / {{ storage_limit|format_bytes }} ({{ percentage|floatformat:1 }}%) used.</span>
            {% endwith %}
            <a href="{% url 'upload_track' %}" class="btn btn-primary"><i class="fas fa-upload me-1"></i> Upload Track</a>
        </div>
    </div>

    <div class="card bg-light mb-4">
        <div class="card-body">
            <form id="filter-sort-form" onsubmit="return false;">
                <div class="row g-3 align-items-end">
                    <!-- Search -->
                    <div class="col-md-4">
                        <label for="title-search-input" class="form-label">Title Search</label>
                        <input type="text" id="title-search-input" class="form-control" value="{{ search_title_query|default:'' }}" placeholder="Keyword...">
                    </div>
                    <!-- Filter by Artist -->
                    <div class="col-md-3">
                        <label for="artist-filter" class="form-label">Artist</label>
                        <select id="artist-filter" class="form-select">
                            <option value="">All Artists</option>
                            {% for artist in artists %}
                                {% if artist %}
                                    <option value="{{ artist }}" {% if artist == selected_artist %}selected{% endif %}>{{ artist }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Filter by Playlist -->
                    <div class="col-md-3">
                        <label for="playlist-filter" class="form-label">Playlist</label>
                        <select id="playlist-filter" class="form-select">
                            <option value="">All Tracks</option>
                            {% for p in playlists %}
                                <option value="{{ p.id }}" {% if p.id == selected_playlist_id %}selected{% endif %}>{{ p.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Sort by -->
                    <div class="col-md-2">
                        <label for="sort-select" class="form-label">Sort By</label>
                        <select id="sort-select" class="form-select">
                            <option value="name" {% if sort_option == 'name' %}selected{% endif %}>Alphabetical</option>
                            <option value="last_played" {% if sort_option == 'last_played' %}selected{% endif %}>Last Played</option>
                        </select>
                    </div>
                </div>
                <div class="row g-3 align-items-end mt-2">
                    <div class="col-md-6 col-lg-12 position-relative">
                        <label for="transcript-search-input" class="form-label">Transcript Search</label>
                        <input type="text" id="transcript-search-input" class="form-control" value="{{ transcript_search_query|default:'' }}" placeholder="Transcript text..." autocomplete="off">
                        <div id="transcript-results-dropdown" class="dropdown-menu w-100 shadow" style="display: none; max-height: 300px; overflow-y: auto;">
                            <!-- Results will be injected here -->
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="list-group" id="track-list-container">
        {% include 'player/partials/track_list_items.html' with tracks=tracks.object_list playlists=playlists %}
    </div>

    <nav id="pagination-container" aria-label="Page navigation">
        {% include 'player/partials/pagination.html' with tracks=tracks %}
    </nav>

{% endblock %}

{% block extra_js %}
<!-- Delete Track Modal -->
<div class="modal fade" id="deleteTrackModal" tabindex="-1" aria-labelledby="deleteTrackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTrackModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the track "<strong id="track-name-to-delete"></strong>"? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const titleSearchInput = document.getElementById('title-search-input');
    const transcriptSearchInput = document.getElementById('transcript-search-input');
    const artistFilter = document.getElementById('artist-filter');
    const playlistFilter = document.getElementById('playlist-filter');
    const sortSelect = document.getElementById('sort-select');
    const trackListContainer = document.getElementById('track-list-container');
    const paginationContainer = document.getElementById('pagination-container');
    const transcriptResultsDropdown = document.getElementById('transcript-results-dropdown');

    let transcriptSearchTimeout = null;

    function handleTranscriptSearch() {
        const query = transcriptSearchInput.value;
        if (query.length < 2) {
            transcriptResultsDropdown.style.display = 'none';
            return;
        }

        clearTimeout(transcriptSearchTimeout);
        transcriptSearchTimeout = setTimeout(() => {
            fetch(`/api/search_transcripts/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        transcriptResultsDropdown.innerHTML = '';
                        data.forEach(result => {
                            const item = document.createElement('a');
                            item.className = 'dropdown-item d-flex align-items-center gap-2 py-2';
                            item.href = '#';
                            item.style.whiteSpace = 'normal';
                            item.innerHTML = `
                                <div class="flex-shrink-0">
                                    ${result.track_icon ? `<img src="${result.track_icon}" style="width: 32px; height: 32px; object-fit: cover; border-radius: 4px;">` : `<div class="bg-secondary d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; border-radius: 4px;"><i class="fas fa-music text-white small"></i></div>`}
                                </div>
                                <div class="flex-grow-1 min-width-0">
                                    <div class="d-flex justify-content-between align-items-baseline">
                                        <strong class="text-truncate" style="max-width: 150px;">${result.track_name}</strong>
                                        <small class="text-primary ms-2">${result.start_time_formatted}</small>
                                    </div>
                                    <div class="small text-muted text-truncate">${result.text}</div>
                                </div>
                            `;
                            item.addEventListener('click', (e) => {
                                e.preventDefault();
                                window.playTrack(
                                    result.track_stream_url,
                                    result.track_name,
                                    result.track_artist,
                                    result.track_icon,
                                    result.track_id,
                                    result.track_type,
                                    result.start_time,
                                    result.track_duration
                                );
                                transcriptResultsDropdown.style.display = 'none';
                            });
                            transcriptResultsDropdown.appendChild(item);
                        });
                        transcriptResultsDropdown.style.display = 'block';
                    } else {
                        transcriptResultsDropdown.style.display = 'none';
                    }
                });
        }, 300);
    }

    transcriptSearchInput.addEventListener('input', handleTranscriptSearch);

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!transcriptSearchInput.contains(e.target) && !transcriptResultsDropdown.contains(e.target)) {
            transcriptResultsDropdown.style.display = 'none';
        }
    });

    function initTooltips() {
        const tooltipElements = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipElements.forEach(el => {
            const existing = bootstrap.Tooltip.getInstance(el);
            if (existing) {
                existing.dispose();
            }
            new bootstrap.Tooltip(el);
        });
    }
    initTooltips();

    function fetchTracks(page) {
        const searchTitle = titleSearchInput.value;
        const searchTranscript = transcriptSearchInput.value;
        const artist = artistFilter.value;
        const playlist = playlistFilter.value;
        const sort = sortSelect.value;

        const params = new URLSearchParams({
            page,
            search_title: searchTitle,
            search_transcript: searchTranscript,
            artist,
            playlist,
            sort
        });
        const url = `?${params.toString()}`;

        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            trackListContainer.innerHTML = data.track_html;
            paginationContainer.innerHTML = data.pagination_html;
            addDeleteModalListener();
            initTooltips();
        })
        .catch(error => console.error('Error fetching tracks:', error));
    }

    // Use event delegation for pagination links
    document.addEventListener('click', function(e) {
        // Find the closest ancestor anchor tag within the pagination container
        const target = e.target.closest('#pagination-container a');

        if (target && !target.closest('.disabled') && !target.closest('.active')) {
            e.preventDefault(); // Prevent default navigation
            const url = new URL(target.href);
            const page = url.searchParams.get('page') || '1';
            fetchTracks(page);
        }
    });

    // Attach event listeners to filter controls
    const filterControls = [artistFilter, playlistFilter, sortSelect];
    filterControls.forEach(control => {
        control.addEventListener('change', () => fetchTracks(1)); // Use 'change' for select/checkbox
    });
    [titleSearchInput, transcriptSearchInput].forEach(input => {
        input.addEventListener('input', () => fetchTracks(1));
    }); // Use 'input' for real-time feedback

    addDeleteModalListener();
    addDeleteConfirmationListener();

    function addDeleteModalListener() {
        const deleteTrackModal = document.getElementById('deleteTrackModal');
        if (deleteTrackModal) {
            deleteTrackModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                trackIdToDelete = button.dataset.trackId;
                const trackName = button.dataset.trackName;
                trackNameToDelete.textContent = trackName;
            });
        }
    }
    const trackNameToDelete = document.getElementById('track-name-to-delete');
    let trackIdToDelete = null;

    function addDeleteConfirmationListener() {
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function () {
        if (!trackIdToDelete) return;

        const url = `/api/track/${trackIdToDelete}/delete/`;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '{{ csrf_token }}';

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast(data.message, 'success');
                const trackItem = document.querySelector(`[data-testid="track-item-${trackIdToDelete}"]`);
                if (trackItem) {
                    trackItem.remove();
                }
                const modalInstance = bootstrap.Modal.getInstance(deleteTrackModal);
                modalInstance.hide();
            } else {
                showToast(data.message || 'An error occurred.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred.', 'error');
        });
            });
        }
    }

});

function toggleTrackInPlaylist(trackId, playlistId, element) {
    const url = "{% url 'add_track_to_playlist' %}";
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '{{ csrf_token }}';

    const formData = new FormData();
    formData.append('track_id', trackId);
    formData.append('playlist_id', playlistId);

    fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        showToast(data.message, 'success');
        if (data.action === 'added') {
            if (!element.querySelector('.fa-check')) {
                const checkmark = document.createElement('i');
                checkmark.className = 'fas fa-check text-success ms-2';
                element.appendChild(checkmark);
            }
        } else if (data.action === 'removed') {
            const checkmark = element.querySelector('.fa-check');
            if (checkmark) {
                checkmark.remove();
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred.', 'error');
    });
}
</script>
{% endblock %}
