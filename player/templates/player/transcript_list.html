{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Transcripts Dashboard</h2>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Track</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Processing Started</th>
                    <th>Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for transcript in transcripts %}
                <tr data-transcript-id="{{ transcript.id }}" data-track-id="{{ transcript.track.id }}">
                    <td>{{ transcript.track.name }}</td>
                    <td class="status-cell">
                        {% include "player/partials/transcript_status.html" %}
                    </td>
                    <td><span class="local-datetime" data-local-datetime="{{ transcript.created_at|date:'c' }}">{{ transcript.created_at|date:"M d, Y H:i" }}</span></td>
                    <td><span class="local-datetime" data-local-datetime="{{ transcript.processing_started_at|date:'c' }}">{{ transcript.processing_started_at|date:"M d, Y H:i" }}</span></td>
                    <td><span class="local-datetime" data-local-datetime="{{ transcript.updated_at|date:'c' }}">{{ transcript.updated_at|date:"M d, Y H:i" }}</span></td>
                    <td>
                        <a href="{% url 'edit_track' transcript.track.id %}" class="btn btn-sm btn-outline-primary">Edit Track</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No transcripts found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const pollInterval = 5000; // 5 seconds

    function checkStatus() {
        const processingRows = document.querySelectorAll('tr[data-transcript-id]');
        const idsToCheck = [];

        processingRows.forEach(row => {
            const badge = row.querySelector('.badge');
            if (badge && (badge.textContent.trim().toLowerCase() === 'processing' || badge.textContent.trim().toLowerCase() === 'pending')) {
                idsToCheck.push(row.dataset.trackId);
            }
        });

        if (idsToCheck.length === 0) return;

        idsToCheck.forEach(trackId => {
            fetch(`/api/transcript/status/${trackId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.html) {
                        const row = document.querySelector(`tr[data-track-id="${trackId}"]`);
                        if (row) {
                            const cell = row.querySelector('.status-cell');
                            // Only update if status changed or content is different
                            if (cell.innerHTML.trim() !== data.html.trim()) {
                                cell.innerHTML = data.html;
                            }
                        }
                    }
                })
                .catch(err => console.error('Error polling status:', err));
        });
    }

    setInterval(checkStatus, pollInterval);
});
</script>
{% endblock %}
