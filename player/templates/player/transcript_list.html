{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Transcripts Dashboard</h2>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Track</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for transcript in transcripts %}
                <tr>
                    <td>{{ transcript.track.name }}</td>
                    <td>
                        <span class="badge {% if transcript.status == 'completed' %}bg-success{% elif transcript.status == 'failed' %}bg-danger{% else %}bg-warning{% endif %}">
                            {{ transcript.status|title }}
                        </span>
                        {% if transcript.status == 'processing' %}
                            <div class="mt-1" style="width: 100px;">
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                         style="width: 0%"
                                         data-start-time="{{ transcript.processing_started_at|date:'U' }}"
                                         data-duration="{{ transcript.track.duration }}"></div>
                                </div>
                                <small class="text-muted eta-text" style="font-size: 0.7em;">Calculating...</small>
                            </div>
                        {% endif %}
                    </td>
                    <td>{{ transcript.created_at|date:"M d, Y H:i" }}</td>
                    <td>{{ transcript.updated_at|date:"M d, Y H:i" }}</td>
                    <td>
                        <a href="{% url 'edit_track' transcript.track.id %}" class="btn btn-sm btn-outline-primary">Edit Track</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No transcripts found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function updateProgress() {
        const now = Math.floor(Date.now() / 1000);
        document.querySelectorAll('.progress-bar').forEach(bar => {
            const startTime = parseInt(bar.dataset.startTime);
            const duration = parseFloat(bar.dataset.duration);

            if (isNaN(startTime) || isNaN(duration) || duration === 0) return;

            // Estimate processing speed (e.g., 20% of duration for 'tiny' model)
            const estimatedProcessingTime = duration * 0.2;
            const elapsed = now - startTime;
            let percent = (elapsed / estimatedProcessingTime) * 100;

            if (percent > 95) percent = 99; // Cap at 99 until actually done

            bar.style.width = percent + '%';

            const etaSeconds = Math.max(0, estimatedProcessingTime - elapsed);
            const etaText = bar.parentElement.nextElementSibling;
            if (etaText) {
                if (percent < 99) {
                    etaText.textContent = `~${Math.ceil(etaSeconds)}s remaining`;
                } else {
                    etaText.textContent = 'Finishing up...';
                }
            }
        });
    }

    setInterval(updateProgress, 1000);
    updateProgress();
});
</script>
{% endblock %}
