{% extends "base.html" %}
{% load player_extras %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ playlist.name }}</h2>
        <div class="d-flex flex-wrap justify-content-end gap-1">
            <button id="play-all-btn" class="btn btn-success"><i class="fas fa-play me-2"></i>Play All</button>
            <a href="{% url 'edit_playlist' playlist.id %}" class="btn btn-primary"><i class="fas fa-pen me-2"></i>Edit Playlist Details</a>
        </div>
    </div>

    <div class="card bg-light mb-4">
        <div class="card-body">
            <form id="filter-sort-form" onsubmit="return false;">
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label for="title-search-input" class="form-label">Title Search</label>
                        <input type="text" id="title-search-input" class="form-control" value="{{ search_title_query|default:'' }}" placeholder="Keyword...">
                    </div>
                    <div class="col-md-6">
                        <label for="transcript-search-input" class="form-label">Transcript Search</label>
                        <input type="text" id="transcript-search-input" class="form-control" value="{{ transcript_search_query|default:'' }}" placeholder="Transcript text...">
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            {% if playlist.image %}
                <img src="{{ playlist.image.url }}" alt="{{ playlist.name }}" class="img-fluid rounded mb-3">
            {% else %}
                <div class="bg-secondary d-flex align-items-center justify-content-center rounded mb-3" style="width: 100%; height: 300px;">
                    <i class="fas fa-music fa-3x text-white"></i>
                </div>
            {% endif %}
        </div>
        <div class="col-md-8">
            <h3>Tracks</h3>
            <ul id="playlist-tracks" class="list-group">
                {% include 'player/partials/playlist_item_list.html' with playlist=playlist playlist_items=playlist_items %}
            </ul>
        </div>
    </div>

    <!-- Remove Track Modal -->
    <div class="modal fade" id="removeTrackModal" tabindex="-1" aria-labelledby="removeTrackModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="removeTrackModalLabel">Confirm Removal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to remove the track "<strong id="track-name-to-remove"></strong>" from this playlist?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-remove-btn">Remove</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
let playlistData = [
    {% for item in playlist_items %}
    {
        id: {{ item.track.id }},
        name: "{{ item.track.name|escapejs }}",
        artist: "{{ item.track.artist|escapejs }}",
        stream_url: "{% url 'stream_track' item.track.id %}",
        icon_url: {% if item.track.icon %}"{{ item.track.icon.url }}"{% else %}null{% endif %},
        type: "{{ item.track.type }}",
        position: {{ item.track.position|default:0 }},
        duration: {{ item.track.duration|default:0 }}
    },
    {% endfor %}
];

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const titleSearchInput = document.getElementById('title-search-input');
    const transcriptSearchInput = document.getElementById('transcript-search-input');
    const playlistTracks = document.getElementById('playlist-tracks');

    let sortableInstance = null;

    function initSortable() {
        if (playlistTracks && !sortableInstance) {
            sortableInstance = new Sortable(playlistTracks, {
                animation: 150,
                handle: '.fa-grip-vertical',
                onEnd: function (evt) {
                    const trackIds = Array.from(evt.target.children).map(li => li.dataset.trackId);
                    const reorderUrl = "{% url 'reorder_playlist' playlist.id %}";

                    const formData = new FormData();
                    trackIds.forEach(id => formData.append('track_ids[]', id));

                    fetch(reorderUrl, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status !== 'success') {
                            console.error('Failed to reorder playlist');
                        } else {
                            // Re-sync the playlistData array with the new order
                            const reorderedPlaylistData = [];
                            trackIds.forEach(id => {
                                const track = playlistData.find(t => t.id == id);
                                if(track) reorderedPlaylistData.push(track);
                            });
                            playlistData = reorderedPlaylistData;
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
            });
        }
    }

    function destroySortable() {
        if (sortableInstance) {
            sortableInstance.destroy();
            sortableInstance = null;
        }
    }

    initSortable();

    function fetchFilteredTracks() {
        const searchTitle = titleSearchInput.value;
        const searchTranscript = transcriptSearchInput.value;

        if (searchTitle || searchTranscript) {
            destroySortable();
        } else {
            initSortable();
        }

        const params = new URLSearchParams({
            search_title: searchTitle,
            search_transcript: searchTranscript
        });
        const url = `?${params.toString()}`;

        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            playlistTracks.innerHTML = data.html;
            playlistData = data.playlist_data;
            initTooltips();
        })
        .catch(error => console.error('Error fetching filtered tracks:', error));
    }

    titleSearchInput.addEventListener('input', fetchFilteredTracks);
    transcriptSearchInput.addEventListener('input', fetchFilteredTracks);

    function initTooltips() {
        const tooltipElements = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipElements.forEach(el => {
            const existing = bootstrap.Tooltip.getInstance(el);
            if (existing) {
                existing.dispose();
            }
            new bootstrap.Tooltip(el);
        });
    }
    initTooltips();

    let playlistIdToRemove = null;
    let trackIdToRemove = null;

    const removeTrackModal = document.getElementById('removeTrackModal');
    if (removeTrackModal) {
        removeTrackModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            playlistIdToRemove = button.dataset.playlistId;
            trackIdToRemove = button.dataset.trackId;
            const trackName = button.dataset.trackName;
            const trackNameElement = document.getElementById('track-name-to-remove');
            trackNameElement.textContent = trackName;
        });
    }

    const confirmRemoveBtn = document.getElementById('confirm-remove-btn');
    if (confirmRemoveBtn) {
        confirmRemoveBtn.addEventListener('click', function () {
            if (!playlistIdToRemove || !trackIdToRemove) return;

            const url = `/playlists/remove_track/${playlistIdToRemove}/${trackIdToRemove}/`;
            const csrfToken = '{{ csrf_token }}';

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const itemToRemove = document.getElementById(`playlist-item-${trackIdToRemove}`);
                    if (itemToRemove) {
                        itemToRemove.remove();
                    }
                    playlistData = playlistData.filter(track => track.id !== parseInt(trackIdToRemove));
                    showToast(data.message, 'success');
                    const modalInstance = bootstrap.Modal.getInstance(removeTrackModal);
                    modalInstance.hide();
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred while removing the track.', 'error');
            });
        });
    }
    const playAllBtn = document.getElementById('play-all-btn');
    if (playAllBtn) {
        playAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (playlistData.length > 0) {
                window.playPlaylist({{ playlist.id }}, "{{ playlist.name|escapejs }}", playlistData, 0);
            } else {
                showToast("This playlist is empty!", "warning");
            }
        });
    }
});
</script>
{% endblock %}
