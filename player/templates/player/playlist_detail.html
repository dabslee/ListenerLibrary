{% extends "content_base.html" %}
{% load player_extras %}

{% block main %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ playlist.name }}</h2>
        <div class="d-flex flex-wrap justify-content-end gap-1">
            <button id="play-all-btn" class="btn btn-success"><i class="fas fa-play me-2"></i>Play</button>
            <button id="shuffle-play-btn" class="btn btn-success"><i class="fas fa-random me-2"></i>Shuffle Play</button>
            <a href="{% url 'edit_playlist' playlist.id %}" class="btn btn-primary" target="content-frame"><i class="fas fa-pen me-2"></i>Edit Playlist</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            {% if playlist.image %}
                <img src="{{ playlist.image.url }}" alt="{{ playlist.name }}" class="img-fluid rounded mb-3">
            {% else %}
                <div class="bg-secondary d-flex align-items-center justify-content-center rounded mb-3" style="width: 100%; height: 300px;">
                    <i class="fas fa-music fa-3x text-white"></i>
                </div>
            {% endif %}
        </div>
        <div class="col-md-8">
            <h3>Tracks</h3>
            <ul id="playlist-tracks" class="list-group">
                {% for item in playlist_items %}
                    <li class="list-group-item d-flex flex-column flex-lg-row justify-content-between"
                        data-track-id="{{ item.track.id }}"
                        id="playlist-item-{{ item.track.id }}"
                        data-testid="track-item-{{ item.track.id }}">
                        <div class="flex-grow-1 d-flex align-items-center" style="cursor: pointer;" onclick="playTrack({{ forloop.counter0 }})">
                            <i class="fas fa-grip-vertical me-3" style="cursor: move;"></i>
                            {% if item.track.icon %}
                                <img src="{{ item.track.icon.url }}" alt="{{ item.track.name }}" style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover;" class="me-3">
                            {% else %}
                                <div class="bg-secondary me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; border-radius: 4px;">
                                    <i class="fas fa-music text-white"></i>
                                </div>
                            {% endif %}
                            <div>
                                <h6 class="mb-0">
                                    {{ item.track.name }}
                                    {% if item.track.get_type_display == 'Podcast' %}
                                        <i class="fas fa-book ms-2 text-secondary" data-bs-toggle="tooltip" title="Podcast"></i>
                                        {% if item.track.transcript %}
                                            <i class="fas fa-font ms-1 text-secondary" data-bs-toggle="tooltip" title="Transcribed"></i>
                                        {% endif %}
                                    {% endif %}
                                </h6>
                                {% if item.track.artist %}
                                    <small class="text-muted">By {{ item.track.artist }}</small>
                                {% endif %}
                            </div>
                            <div class="mb-2 d-lg-none d-block flex-grow-1 text-end">
                                <button class="btn btn-outline-danger btn-sm"
                                        onclick="event.stopPropagation();"
                                        data-bs-toggle="modal"
                                        data-bs-target="#removeTrackModal"
                                        data-playlist-id="{{ playlist.id }}"
                                        data-track-id="{{ item.track.id }}"
                                        data-track-name="{{ item.track.name|escapejs }}"
                                        title="Remove from Playlist">
                                    <i class="fas fa-xmark"></i>
                                </button>
                            </div>
                        </div>
                        <div class="d-flex flex-row align-items-center justify-content-end" style="min-width: 150px;">
                            {% if item.track.type == 'podcast' %}
                                <div class="w-100 me-3 mt-2 mt-lg-0">
                                    <div class="progress" style="height: 5px;">
                                        <div class="progress-bar" role="progressbar" style="width: {{ item.track.progress_percentage|default:0 }}%;" aria-valuenow="{{ item.track.progress_percentage|default:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <div class="d-flex justify-content-end d-none d-lg-block">
                                        <small class="text-muted podcast-progress-time">{{ item.track.position|format_duration }} / {{ item.track.duration|format_duration }}</small>
                                    </div>
                                </div>
                            {% endif %}
                            <div class="mb-2 d-lg-block d-none">
                                <button class="btn btn-outline-danger btn-sm"
                                        onclick="event.stopPropagation();"
                                        data-bs-toggle="modal"
                                        data-bs-target="#removeTrackModal"
                                        data-playlist-id="{{ playlist.id }}"
                                        data-track-id="{{ item.track.id }}"
                                        data-track-name="{{ item.track.name|escapejs }}"
                                        title="Remove from Playlist">
                                    <i class="fas fa-xmark"></i>
                                </button>
                            </div>
                        </div>
                    </li>
                {% empty %}
                    <li class="list-group-item">This playlist is empty.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Remove Track Modal -->
    <div class="modal fade" id="removeTrackModal" tabindex="-1" aria-labelledby="removeTrackModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="removeTrackModalLabel">Confirm Removal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to remove the track "<strong id="track-name-to-remove"></strong>" from this playlist?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-remove-btn">Remove</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
let playlistData = [
    {% for item in playlist_items %}
    {
        id: {{ item.track.id }},
        name: "{{ item.track.name|escapejs }}",
        artist: "{{ item.track.artist|escapejs }}",
        stream_url: "{% url 'stream_track' item.track.id %}",
        icon_url: {% if item.track.icon %}"{{ item.track.icon.url }}"{% else %}null{% endif %},
        type: "{{ item.track.type }}",
        position: {{ item.track.position|default:0 }},
        duration: {{ item.track.duration|default:0 }}
    },
    {% endfor %}
];

function playTrack(index) {
    playPlaylist({{ playlist.id }}, '{{ playlist.name|escapejs }}', playlistData, index, false);
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    function playPlaylist(playlistId, playlistName, tracks, startIndex, shuffle) {
        if (!tracks || tracks.length === 0) {
            showToast("This playlist is empty!", "warning");
            return;
        }
        window.parent.postMessage({
            action: 'playPlaylist',
            playlistId: playlistId,
            playlistName: playlistName,
            tracks: tracks,
            startIndex: startIndex,
            shuffle: shuffle
        }, '{{ origin }}'.slice(0, -1));
    }

    window.playPlaylist = playPlaylist; // Make it accessible to inline onclick

    function initTooltips() {
        const tooltipElements = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipElements.forEach(el => {
            const existing = bootstrap.Tooltip.getInstance(el);
            if (existing) existing.dispose();
            new bootstrap.Tooltip(el);
        });
    }
    initTooltips();

    let playlistIdToRemove = null;
    let trackIdToRemove = null;

    const removeTrackModal = document.getElementById('removeTrackModal');
    if (removeTrackModal) {
        removeTrackModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            playlistIdToRemove = button.dataset.playlistId;
            trackIdToRemove = button.dataset.trackId;
            const trackName = button.dataset.trackName;
            document.getElementById('track-name-to-remove').textContent = trackName;
        });
    }

    const confirmRemoveBtn = document.getElementById('confirm-remove-btn');
    if (confirmRemoveBtn) {
        confirmRemoveBtn.addEventListener('click', function () {
            if (!playlistIdToRemove || !trackIdToRemove) return;
            const url = `/playlists/remove_track/${playlistIdToRemove}/${trackIdToRemove}/`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById(`playlist-item-${trackIdToRemove}`)?.remove();
                    playlistData = playlistData.filter(track => track.id !== parseInt(trackIdToRemove));
                    showToast(data.message, 'success');
                    bootstrap.Modal.getInstance(removeTrackModal).hide();
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred while removing the track.', 'error');
            });
        });
    }

    document.getElementById('play-all-btn')?.addEventListener('click', (e) => {
        e.preventDefault();
        playPlaylist({{ playlist.id }}, "{{ playlist.name|escapejs }}", playlistData, 0, false);
    });

    document.getElementById('shuffle-play-btn')?.addEventListener('click', (e) => {
        e.preventDefault();
        playPlaylist({{ playlist.id }}, "{{ playlist.name|escapejs }}", playlistData, 0, true);
    });

    const playlistTracks = document.getElementById('playlist-tracks');
    if (playlistTracks) {
        new Sortable(playlistTracks, {
            animation: 150,
            handle: '.fa-grip-vertical',
            onEnd: function (evt) {
                const trackIds = Array.from(evt.target.children).map(li => li.dataset.trackId);
                const reorderUrl = "{% url 'reorder_playlist' playlist.id %}";
                const formData = new FormData();
                trackIds.forEach(id => formData.append('track_ids[]', id));
                fetch(reorderUrl, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const reorderedPlaylistData = trackIds.map(id => playlistData.find(t => t.id == id)).filter(Boolean);
                        playlistData = reorderedPlaylistData;
                    } else {
                        console.error('Failed to reorder playlist');
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    }
});
</script>
{% endblock %}
